# Building Linken Container Image

Linken container image is generated by using Docker with the current stable Debian `debian:11` (codename: `bullseye`) as the base image.
See `Dockerfile.v1` at the project root.

The container has the following packages available:

| #  | Package      | GitHub                    | Version | Description
| -- | :------      | :-----                    | :--      | :----------
| 1  | `bwa`        | `lh3/bwa`                 | `master` | Source codes are downloaded and compiled during the container build step. Couldn't pin to release version `0.7.17 (r1188)` due to compile error.
| 2  | `bwa-mem2`   | `bwa-mem2/bwa-mem2`       | 2.2.1    | Source codes are downloaded and compiled during the container build step.
| 3  | `minimap2`   | `lh3/minimap2`            | 2.24     | Source codes are downloaded and compiled during the container build step.
| 4  | `samtools`   | `samtools/samtools`       | 1.17     | Source codes are downloaded and compiled during the container build step.
| 5  | `picard.jar` | `broadinstitute/picard`   | 3.0.0    | The jar-executable file `picard.jar` is placed at `/usr/local/lib/picard.jar`.
| 6  | `cutadapt`   | `marcelm/cutadapt`        | 4.2      | Available through `pip`; the installation takes place in the final image instead of the base image.
| 7  | `fastqc`     | `s-andrews/FastQC`        | 0.12.1   | This is a Java executable. It is downloaded from the official website and placed at `/usr/local/lib/fastqc`. The executable `/usr/local/lib/fastqc/fastqc` is symlinked to `/usr/local/bin/fastqc`.
| 8  | `trimgalore` | `FelixKrueger/TrimGalore` | 0.6.10   | The executable script is placed at `/usr/local/bin/trimgalore`.
| 9  | `HTSlib`     | `samtools/htslib`         | 1.17     | Source codes are downloaded and compiled during the container build step.
| 10 | `lofreq`     | `CSB5/lofreq`             | 2.1.5    | Source codes are downloaded and compiled during the container build step.
| 11 | `bcftools`   | `samtools/bcftools`       | 1.17     | Source codes are downloaded and compiled during the container build step.
| 12 | `gatk`       | `broadinstitute/gatk`     | 4.3.0.0  | The bundled java executables are downloaded and placed at `/usr/local/lib/gatk`.

To build the container image:

```bash
# In project's root
docker build --tag aixnr/linken:latest --file Dockerfile.v1 .

# To clear builder's cache
docker builder prune

# To force a clean build by pulling latest version and no caching
docker build --pull --no-cache --tag aixnr/linken:latest .
```

On a 4c/8t machine (AMD Ryzen 5 1400), the whole container build step could take around 5 - 6 minutes to complete.
The final size of this container image is 1.34 GB.
To test the container image:

```bash
# Long format
docker run --interactive --tty --name linken aixnr/linken /bin/bash

# Short format
docker run -it --name linken aixnr/linken /bin/bash
```


## Testing The Workflow For Each Tool

During testing, the `ENTRYPOINT` section of the final stage docker image were modified to permit single-binary testing.
Example below:

```Dockerfile
ENTRYPOINT ["bwa", "index"]
```

This allows for the user to run `aixnr/linken` container image as follows:

```bash
docker run -v $(pwd):/data --rm aixnr/linken /data/H1N1-PR8-WG.fasta -p /data/test
```

- `-v $(pwd):/data` mounts current working directory (`$(pwd)`) on host as `/data` on the container.
- `--rm` deletes the container after exiting.
- `aixnr/linken` is the name of the container image.
- `/data/H1N1-PR8-WG.fasta -p /data/test` is passed to the `ENTRYPOINT`, which then gets evaluated as `bwa index /data/H1N1-PR8-WG.fasta -p /data/test`.

Also during testing, the container was started in current directory where raw reads were located at `$(pwd)/raw_reads` subdirectory.
The current `$(pwd)` was mounted inside the container at `/EXPERIMENT` to test the pipeline.

```bash
docker run -it --name linken --volume $(pwd):/EXPERIMENT --rm aixnr/linken /bin/bash
```

The reference index `[reference.fasta]` that was used was IAV PR8, available on `aixnr/linken-contrib` GitHub repo.

```bash
apt-get update && apt-get install -y curl
cd EXPERIMENT
mkdir index
curl -L https://raw.githubusercontent.com/aixnr/linken-contrib/main/IAV/H1N1-PR8-WG.fasta \
	--output ./index/ref.fasta
```

Test commands:

```bash
# Generating index files (output directory: ./index)
bwa index ./index/ref.fasta -p ./index/ref
samtools faidx ./index/ref.fasta
java -jar /usr/local/lib/picard.jar CreateSequenceDictionary R=./index/ref.fasta O=./index/ref.dict


# Trimming (output directory: ./trimmed)
mkdir trimmed
trimgalore --paired ./raw_reads/[S1_R1.fastq.gz] raw_reads/[S1_R2.fastq.gz] --output_dir=trimmed


# Mapping reads (output directory: ./artifacts)
mkdir artifacts
bwa mem -M ./index/ref ./trimmed/[S1_R1.fq.gz] ./trimmed/[S1_R2.fq.gz] | \
	samtools view --bam | \
	samtools sort -o ./artifacts/[S1.bwa.bam]

samtools index ./artifacts/[S1.bwa.bam]


# Generate coverage information (output directory: ./artifacts)
samtools mpileup ./artifacts/[S1.bwa.bam] --fasta-ref ./index/ref.fasta | \
	awk '{print $1"\t"$2"\t"$3"\t"$4}' > ./artifacts/[S1]_coverage.tsv
```

All these commands were run inside the working directory at `/EXPERIMENT`.
For testing, cores/threads/processes parameter was not set.
For more info, see `docs/commands.md`.


## Running Container with Singularity/Apptainer

The `apptainer` and `singularity` packages are available through `dnf` on Fedora.
Install them first, and then convert `aixnr/linken` docker image to `SIF` Singularity image format.

```bash
# List all container images
docker images

# Assuming the aixnr/linken:latest container image is available
apptainer build linkenc docker-daemon:aixnr/linken:latest

# Run container through shell
apptainer shell linkenc

# Run program that's available within linken.sif
apptainer exec linkenc samtools
```

`linkenc` stands for *linken container* and it is an executable and can be run as follows: `./linken.sif`.
Place it under path (e.g. at `~/.local/bin/linkenc`) and now it can be called as easy as `linkenc` (*linken container*).

If `--sandbox` flag is supplied, `apptainer` will produce a directory `linken` with all subdirectories visible.
This is useful for mutating the container, i.e., adding more packages.
When running a SIF container, `apptainer` mounts user's `$HOME` by default and sets its `$WORKDIR` to `$PWD`, and using the current `uid` and `gid`.
Therefore, mounting is not necessary anymore and we are unlikely to bump into permission issues.

However when working with data outside of `$HOME`, binding is required:

```bash
export SINGULARITY_BIND=/hpcdata/
```

With `SINGULARITY_BIND`, the Apptainer/Singularity runtime is aware of location outside `$HOME`.

Of note, depending on the situation, `build` can fail because of insufficient space in `/tmp`.

```bash
mkdir APPTAINER_TMPDIR
export APPTAINER_TMPDIR=$(pwd)/APPTAINER_TMPDIR
apptainer build linken.sif docker-daemon:aixnr/linken:latest
```

